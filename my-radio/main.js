!function(){"use strict";const t=(t,e)=>{t&&Object.keys(t).forEach(s=>e.setAttribute(s,`${t[s]}`))},e=(t,e)=>{e&&e.appendChild(t)},s=document,i=window,a=(i,a=null,n=null)=>{const r=s.createElement(i);return t(n,r),e(r,a),r},n=(i,a=null,n=null)=>{const r=s.createElementNS("http://www.w3.org/2000/svg",i);return t(n,r),e(r,a),r},r=(t,e)=>{let s=t;for(const t of e.split("."))if(!(s=s[t]))return null;return s},o=t=>e=>{if(!e)return null;let s=r(e,t.artist),i=r(e,t.song);if(!s||!i){const a=r(e,t.alt),n=(a||"").split(" - ");[s,i]=2===n.length?n:[a,null]}return{artist:s,song:i}};class h{constructor(){this.onLoad=(t=>this.onLoadAction=t),this.get=(t=>fetch(`${t.url}?t=${Date.now()}`).then(t=>t.json()).then(o(t)).catch(t=>null))}stop(){this.timer&&(clearTimeout(this.timer),this.timer=null)}async start(t){this.stop(),await this.load(t)}async load(t){let e=this.timer;const s=await this.get(t)||{artist:null,song:null};e&&e!==this.timer||(this.onLoadAction(s,t.url),this.timer=e=setTimeout(()=>this.load(t),4e3))}}const l="player_state_changed",c="player_metadata_changed";class u{constructor(t,e,s){this.audioElement=t,this.stations=e,this.metadataLoader=s,this.current=null,this.playing=!1,this.metadata={},this.metadataMap={},this.onStateChanged=(t=>this.subscribe(l,t)),this.onMetadataChanged=(t=>this.subscribe(c,t)),t.addEventListener("pause",()=>this.pauseInternal()),t.addEventListener("play",()=>this.playInternal()),e.map((t,e)=>{t.title&&(this.metadataMap[t.title.url]=e)}),s.onLoad((t,e)=>this.updateMetadata(t,e))}play(t){this.playing&&this.audioElement.pause(),this.current!==t&&(this.audioElement.src=this.stations[t].url,this.current=t),this.audioElement.load(),this.audioElement.play()}stop(){this.audioElement.pause()}toggle(t){this.playing&&this.current===t?this.stop():this.play(t)}playInternal(){this.playing=!0;const{current:t,playing:e}=this,s=this.stations[t].title;s?this.metadataLoader.start(s):this.metadataLoader.stop(),this.notice(l,{current:t,playing:e})}pauseInternal(){this.playing=!1,this.metadataLoader.stop();const{current:t,playing:e}=this;this.notice(l,{current:t,playing:e})}updateMetadata(t,e){this.metadata=Object.assign({},this.metadata,{[this.metadataMap[e]]:t}),this.notice(c,this.metadata)}subscribe(t,e){this.audioElement.addEventListener(t,t=>e(t.detail))}notice(t,e=null){const s=new CustomEvent(t,{detail:e});this.audioElement.dispatchEvent(s)}}const d=128;class p{constructor(t){this.audio=t,this.onChangeActions=[],this.onChange=(t=>this.onChangeActions.push(t))}init(){if(this.analyser)return;const t=new AudioContext,e=t.createMediaElementSource(this.audio),s=t.createAnalyser();this.analyser=s,e.connect(s),s.connect(t.destination),s.fftSize=d;const i=s.frequencyBinCount;this.data=new Uint8Array(i),this.requestData()}requestData(){this.analyser.getByteFrequencyData(this.data),this.onChangeActions.forEach(t=>t(this.data)),requestAnimationFrame(this.requestData.bind(this))}}const m="list",y="station",g="title",f="song",w="artist",q="equalizer-container",v="equalizer",C="active",E="a",L="audio",b="div",A="li",M="span",z="svg",I="ul";class k{constructor(t,e){this.audio=a(L,null,{crossorigin:"anonymous"}),this.list=a(I,null,{class:m}),this.ids=[],this.items={},this.meta={},this.onItemClick=(()=>{}),t.forEach((t,e)=>this.list.appendChild(this.createItem(t,e))),e&&(this.equalizerContainer=a(b,null,{class:q}),this.equalizer=n(z,null,{class:v}),this.equalizerContainer.appendChild(this.equalizer))}render(t){t.appendChild(this.audio),this.equalizerContainer&&t.appendChild(this.equalizerContainer),t.appendChild(this.list)}onToggle(t){this.onItemClick=t}setState({current:t,playing:e}){this.ids.forEach(s=>{const i=this.items[s];e&&t===s?i.classList.add(C):i.classList.remove(C)})}setMetadata(t){this.ids.forEach(e=>{const s=t[e]||{},i=this.meta[e];this.setMeta(i.song,s.song),this.setMeta(i.artist,s.artist)})}setMeta(t,e){e?t.classList.add(C):t.classList.remove(C),t.textContent=e}createItem(t,e){const s=a(A),i=a(E,s),n=a(M,i,{class:y}),r=a(M,i,{class:g}),o=a(M,r,{class:f}),h=a(M,r,{class:w});return n.textContent=t.name,this.ids.push(e),this.items[e]=s,this.meta[e]={song:o,artist:h},i.addEventListener("click",()=>this.onItemClick(e)),s}}const S="line",P=28;class ${constructor(t,e){this.svg=t,this.frequencyProvider=e,this.frequencies=Array(P).fill(0).map((e,s)=>this.addFrequencyItem(t,s)),this.frequencyProvider.onChange(this.update.bind(this))}addFrequencyItem(t,e){const s=11*e+6;return n(S,t,{class:"frequency",x1:s,y1:2,x2:s,y2:62,"stroke-dasharray":"0 60","stroke-dashoffset":-30})}update(t){const e=this.frequencies;for(let s=0;s<P;s++){const i=60*Math.pow((t[2*s]+t[2*s+1])/510,3),a=60-i,n=e[s];n.setAttribute("stroke-dasharray",`${i} ${a}`),n.setAttribute("stroke-dashoffset",`${-a/2}`)}}}class j{constructor(t,{stations:e,equalizer:s}){this.container=t,this.view=new k(e,s);const i=new h;this.player=new u(this.view.audio,e,i),s&&(this.frequencyProvider=new p(this.view.audio),this.equalizer=new $(this.view.equalizer,this.frequencyProvider))}init(){this.view.render(this.container),this.view.onToggle(t=>this.player.toggle(t)),this.player.onStateChanged(t=>this.view.setState(t)),this.player.onMetadataChanged(t=>this.view.setMetadata(t)),this.frequencyProvider&&this.player.onStateChanged(t=>this.frequencyProvider.init())}}(async()=>{const t=!(()=>/mobi/i.test(i.navigator.userAgent))(),{stations:e}=await(async()=>{const t=await fetch("data.json");return await t.json()})();new j(s.body,{stations:e,equalizer:t}).init()})()}();